---
// メインSCSSファイルをインポート
import '../../styles/main.scss';
// Swiper CSS
import 'swiper/css';
import 'swiper/css/pagination';
import BottomBar from '../../components/BottomBar.astro';
import MenuOverlay from '../../components/MenuOverlay.astro';
import Sidebar from '../../components/Sidebar.astro';
import Footer from '../../components/Footer.astro';
import VideoModal from '../../components/VideoModal.astro';
import BookingModal from '../../components/Booking-modal.astro';
import { activities, type Activity } from '../../data/activities';

// 画像
import { getImage } from 'astro:assets';
import slide01 from '../../assets/images/activities/01_jukai-trail.jpg';

// フォーマット
const slideImage01 = await getImage({
  src: slide01,
  format: 'webp',
  widths: [580, 900, 1050],
});

// 動的ルーティング用のパス生成
export async function getStaticPaths() {
  return activities.map((activity: Activity) => ({
    params: { slug: activity.slug },
    props: { activity },
  }));
}

// URLパラメータからslugを取得
const { slug } = Astro.params;
const { activity }: { activity: Activity } = Astro.props;

// 404チェック（念のため）
if (!activity) {
  return Astro.redirect('/404');
}

// ページタイトルを動的に設定
const pageTitle = `${activity.title} | クワルビリゾート`;
---

<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>{pageTitle}</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Allura&family=Zen+Kaku+Gothic+New:wght@400;500;900&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="layout-container">
      <!-- サイドバー -->
      <Sidebar />
      <!-- スマホ専用の下部固定バー -->
      <BottomBar />
      <!-- メニューオーバーレイ -->
      <MenuOverlay />
      <!-- 動画モーダル（メニューオーバーレイより上位階層） -->
      <VideoModal />
      <!-- 宿泊予約モーダル（動画モーダルと同等階層） -->
      <BookingModal />

      <!-- メインコンテンツ -->
      <main class="main-content">
        <article class="activity-detail">
          <header class="activity-detail__header">
            <div class="activity-detail__title-wrapper">
              <div class="activity-detail__category">JUKAI TRAIL</div>
            </div>
            <h1 class="activity-detail__title">樹海トレイル</h1>
          </header>

          <section class="activity-detail__gallery">
            <div class="activities-detail__swiper">
              <div class="swiper-wrapper">
                <div class="swiper-slide">
                  <picture class="activity-detail__picture">
                    <!-- デスクトップ（1024px以上）→ 最高解像度版 -->
                    <source
                      media="(min-width: 1024px)"
                      srcset={slideImage01.srcSet.toString()}
                    />
                    <!-- タブレット（744px以上）→ 中解像度版 -->
                    <source
                      media="(min-width: 744px)"
                      srcset={slideImage01.srcSet.toString()}
                    />
                    <!-- スマホ（744px未満）→ 最小解像度版 -->
                    <img
                      src={slideImage01.src}
                      alt="樹海トレイルの風景"
                      class="activity-detail__image"
                    />
                  </picture>
                </div>
                <!-- テスト用スライド2 -->
                <div class="swiper-slide">
                  <picture class="activity-detail__picture">
                    <img
                      src={slideImage01.src}
                      alt="樹海トレイルの風景2"
                      class="activity-detail__image"
                    />
                  </picture>
                </div>
                <!-- テスト用スライド3 -->
                <div class="swiper-slide">
                  <picture class="activity-detail__picture">
                    <img
                      src={slideImage01.src}
                      alt="樹海トレイルの風景3"
                      class="activity-detail__image"
                    />
                  </picture>
                </div>
              </div>
              <!-- ページネーション（既存のクラス名も維持） -->
              <div class="swiper-pagination activity-detail__pager"></div>
            </div>
          </section>

          <section class="activity-detail__intro">
            <h2 class="activity-detail__intro-title">
              不思議の森の<br />
              不思議な冒険
            </h2>

            <div class="activity-detail__intro-content">
              <p class="activity-detail__intro-text">
                樹海ってどんな森？太古の森？土がほとんどない森、樹海の不思議に迫ります。
              </p>
              <p class="activity-detail__intro-text">
                スライドで樹海の成り立ちを学んだあと、テーマを決めて樹海へ入ります。原生林を歩きながら、それぞれの課題をクリアしていく冒険。終了後は時間があればそれぞれの観察を互いに発表をするのもおすすめです。
              </p>
            </div>
          </section>

          <span class="activity-detail__divider"></span>

          <nav class="activity-detail__nav">
            <a href="#highlights" class="activity-detail__nav-item"
              ><span class="activity-detail__nav-text">おすすめポイント</span
              ></a
            >
            <a href="#overview" class="activity-detail__nav-item"
              ><span class="activity-detail__nav-text">概要・料金</span></a
            >
            <a href="#program" class="activity-detail__nav-item"
              ><span class="activity-detail__nav-text">プログラムの流れ</span
              ></a
            >
            <a href="#booking" class="activity-detail__nav-item"
              ><span class="activity-detail__nav-text">ご予約</span></a
            >
          </nav>
        </article>

        <!-- ここから下におすすめポイントなどのセクションが追加される -->
      </main>
      <!-- フッター -->
      <Footer />
    </div>

    <script>
      // Swiperのインポート
      import Swiper from 'swiper';
      import { Pagination, Autoplay } from 'swiper/modules';

      // DOMロード後に実行
      document.addEventListener('DOMContentLoaded', () => {
        // Swiper初期化（activities-detail専用・完全独立）
        new Swiper('.activities-detail__swiper', {
          modules: [Pagination, Autoplay],
          slidesPerView: 1,
          spaceBetween: 20,
          autoplay: {
            delay: 4000,
            disableOnInteraction: false,
          },
          pagination: {
            el: '.activity-detail__pager',
            clickable: true,
          },
        });

        // メニュー機能
        const pcMenuToggle = document.getElementById('menu-toggle');
        const mobileMenuToggle = document.querySelector('.bottom-bar__toggle');
        const mobileMenuClose = document.querySelector('.menu-overlay__close');
        const menuOverlay = document.getElementById('menu-overlay');
        const sidebar = document.querySelector('.sidebar');

        // メニュー状態管理
        let isMenuOpen = false;

        // メニュー開閉の共通関数
        function toggleMenu() {
          if (!menuOverlay) return;

          isMenuOpen = !isMenuOpen;

          if (isMenuOpen) {
            menuOverlay.classList.add('show');
            if (sidebar) {
              sidebar.classList.add('menu-open');
            }
            // スクロールを禁止
            document.body.style.overflow = 'hidden';
          } else {
            menuOverlay.classList.remove('show');
            if (sidebar) {
              sidebar.classList.remove('menu-open');
            }
            // スクロールを復元
            document.body.style.overflow = '';
          }
        }

        // メニューを閉じる関数
        function closeMenu() {
          if (!menuOverlay) return;

          isMenuOpen = false;
          menuOverlay.classList.remove('show');
          if (sidebar) {
            sidebar.classList.remove('menu-open');
          }
          // スクロールを復元
          document.body.style.overflow = '';
        }

        // 動画モーダル関連の要素
        const videoModal = document.querySelector(
          '.video-modal'
        ) as HTMLElement | null;
        const videoModalClose = document.querySelector(
          '.video-modal__close'
        ) as HTMLElement | null;
        const heroMovieThumbnail = document.querySelector(
          '.hero__movie-thumbnail'
        ) as HTMLElement | null;
        const heroMoviePlayIcon = document.querySelector(
          '.hero__movie-play-icon'
        ) as HTMLElement | null;
        const heroMoviePlayText = document.querySelector(
          '.hero__movie-play-text'
        ) as HTMLElement | null;
        const videoIframe = document.querySelector(
          '.video-modal iframe'
        ) as HTMLIFrameElement | null;

        // 動画モーダルを開く関数
        function openVideoModal() {
          if (videoModal) {
            videoModal.style.opacity = '1';
            videoModal.style.visibility = 'visible';
            // スクロールを禁止
            document.body.style.overflow = 'hidden';
          }
        }

        // 動画モーダルを閉じる関数
        function closeVideoModal() {
          if (videoModal && videoIframe) {
            videoModal.style.opacity = '0';
            videoModal.style.visibility = 'hidden';
            // 動画を停止（iframe srcを再設定）
            const currentSrc = videoIframe.src;
            videoIframe.src = '';
            videoIframe.src = currentSrc;
            // スクロールを復元
            document.body.style.overflow = '';
          }
        }

        // サムネイルクリックで動画モーダルを開く
        if (heroMovieThumbnail) {
          heroMovieThumbnail.addEventListener('click', openVideoModal);
        }

        // 再生アイコンクリックで動画モーダルを開く
        if (heroMoviePlayIcon) {
          heroMoviePlayIcon.addEventListener('click', openVideoModal);
        }

        // 再生テキストクリックで動画モーダルを開く
        if (heroMoviePlayText) {
          heroMoviePlayText.addEventListener('click', openVideoModal);
        }

        // モーダル閉じるボタン
        if (videoModalClose) {
          videoModalClose.addEventListener('click', closeVideoModal);
        }

        // オーバーレイクリックで閉じる（任意）
        if (videoModal) {
          videoModal.addEventListener('click', (e) => {
            if (
              e.target === videoModal ||
              (e.target as HTMLElement).classList.contains(
                'video-modal__overlay'
              )
            ) {
              closeVideoModal();
            }
          });
        }

        // ブッキングモーダル関連の要素
        const bookingModal = document.querySelector(
          '.booking-modal'
        ) as HTMLElement | null;
        const bookingModalClose = document.querySelector(
          '.booking-modal__close'
        ) as HTMLElement | null;
        const sidebarBookingButton = document.querySelector(
          '.sidebar-menu-button'
        ) as HTMLElement | null;
        const menuOverlayBookingButton = document.querySelector(
          '.menu-overlay__button'
        ) as HTMLElement | null;
        const bottomBarBookingButton = document.querySelector(
          '.bottom-bar__button'
        ) as HTMLElement | null;

        // ブッキングモーダルを開く関数
        function openBookingModal() {
          if (bookingModal) {
            bookingModal.style.opacity = '1';
            bookingModal.style.visibility = 'visible';
            // スクロールを禁止
            document.body.style.overflow = 'hidden';
          }
        }

        // ブッキングモーダルを閉じる関数
        function closeBookingModal() {
          if (bookingModal) {
            bookingModal.style.opacity = '0';
            bookingModal.style.visibility = 'hidden';
            // スクロールを復元
            document.body.style.overflow = '';
          }
        }

        // ブッキングモーダル閉じるボタン
        if (bookingModalClose) {
          bookingModalClose.addEventListener('click', closeBookingModal);
        }

        // サイドバーの宿泊予約ボタンクリック（タブレット・デスクトップ）
        if (sidebarBookingButton) {
          sidebarBookingButton.addEventListener('click', (e) => {
            e.preventDefault();
            openBookingModal();
          });
        }

        // メニューオーバーレイの宿泊予約ボタンクリック（スマホメニュー内）
        if (menuOverlayBookingButton) {
          menuOverlayBookingButton.addEventListener('click', (e) => {
            e.preventDefault();
            openBookingModal();
          });
        }

        // スマホ下部バーの宿泊予約ボタンクリック
        if (bottomBarBookingButton) {
          bottomBarBookingButton.addEventListener('click', (e) => {
            e.preventDefault();
            openBookingModal();
          });
        }

        // ブッキングモーダルオーバーレイクリックで閉じる
        if (bookingModal) {
          bookingModal.addEventListener('click', (e) => {
            if (
              e.target === bookingModal ||
              (e.target as HTMLElement).classList.contains(
                'booking-modal__overlay'
              )
            ) {
              closeBookingModal();
            }
          });
        }

        // 必要な要素が存在することを確認してイベントリスナーを設定
        if (menuOverlay) {
          // PCメニューボタン
          if (pcMenuToggle) {
            pcMenuToggle.addEventListener('click', toggleMenu);
          }

          // スマホメニュー開くボタン
          if (mobileMenuToggle) {
            mobileMenuToggle.addEventListener('click', toggleMenu);
          }

          // スマホメニュー閉じるボタン
          if (mobileMenuClose) {
            mobileMenuClose.addEventListener('click', closeMenu);
          }
        }
      });
    </script>
  </body>

  <style lang="scss">
    // 必要なmixin/functionをインポート
    @import '../../styles/variables';
    @import '../../styles/functions';
    @import '../../styles/mixins';

    /* 基本構造 */
    .layout-container {
      display: grid;
      grid-template:
        'main'
        'footer'
        /1fr;
      min-height: 100vh;
      @include tablet-up {
        grid-template:
          'sidebar main'
          'sidebar footer'
          / tpx($sidebar-width) 1fr;
      }
      @include desktop-up {
        grid-template:
          'sidebar main'
          'sidebar footer'
          / ppx($sidebar-width) 1fr;
      }
    }

    /* メインコンテンツ */
    .main-content {
      grid-area: main;
      position: relative;
    }

    /* アクティビティ詳細 */
    .activity-detail {
      background: var(--blue_2, #e7f3f9);
      padding-top: spx(110);
      padding-bottom: spx(30);
      position: relative;
      @include tablet-up {
        padding-top: 0;
        padding-bottom: ppx(51 * 1.2);
      }
      @include desktop-up {
        padding-bottom: ppx(51);
      }

      &__header {
        @include tablet-up {
        }
        @include desktop-up {
        }
      }

      &__title-wrapper {
        width: spx(600);
        margin-inline: auto;
        @include tablet-up {
          margin-inline: unset;
          padding-top: ppx(580 * 1.2);
          margin-left: ppx(233 * 0.5);
          width: ppx(790 * 1.2);
        }
        @include desktop-up {
          padding-top: ppx(580);
          margin-left: ppx(233);
          width: ppx(790);
        }
        &:after {
          content: '';
          display: block;
          width: spx(231);
          height: spx(5);
          background: linear-gradient(
            to right,
            var(--green_2, #adc400) 0%,
            /* 左：緑色 */ var(--green_2, #adc400) 48.6%,
            /* 87/179 ≈ 48.6% まで緑 */ transparent 48.6%,
            /* 透明開始 */ transparent 51.4%,
            /* 透明終了 (48.6% + 5/179*100% ≈ 51.4%) */ var(--blue_4, #59a1c0)
              51.4%,
            /* 青色開始 */ var(--blue_4, #59a1c0) 100% /* 右端まで青 */
          );
          margin-inline: auto;
          margin-top: spx(5);
          @include tablet-up {
            height: ppx(5) * 1.2;
            width: ppx(231) * 1.2;
            margin-inline: unset;
            margin-top: ppx(20 * 1.2);
          }
          @include desktop-up {
            height: ppx(5);
            width: ppx(231);
            margin-top: ppx(20);
          }
        }
      }

      &__category {
        color: var(--blue_5, #026995);
        text-align: center;
        font-size: spx(84);
        font-weight: 700;
        line-height: spx(115); /* 136.905% */
        letter-spacing: spx(2.52);
        @include tablet-up {
          text-align: left;
          font-size: ppx(115 * 1.2);
          line-height: ppx(115 * 1.2); /* 100% */
          letter-spacing: ppx(3.45 * 1.2);
        }
        @include desktop-up {
          font-size: ppx(115);
          line-height: ppx(115); /* 100% */
          letter-spacing: ppx(3.45);
        }
      }

      &__title {
        color: var(--blue_6, #054965);
        text-align: center;
        font-size: spx(33);
        font-weight: 400;
        line-height: spx(34); /* 103.03% */
        margin-top: spx(20);
        width: spx(600);
        margin-inline: auto;
        @include tablet-up {
          margin-inline: unset;
          text-align: left;
          font-size: ppx(34 * 1.2);
          line-height: ppx(34 * 1.2); /* 100% */
          margin-top: ppx(25 * 1.2);
          margin-left: ppx(233 * 0.5);
          width: ppx(790 * 1.2);
        }
        @include desktop-up {
          font-size: ppx(34);
          line-height: ppx(34); /* 100% */
          margin-top: ppx(25);
          margin-left: ppx(233);
          width: ppx(790);
        }
      }

      $slide-width-spx: 580;
      $slide-width-tpx: 1050 * 1;
      $slide-width-ppx: 1050;

      &__gallery {
        margin-top: spx(60);
        @include tablet-up {
          margin-top: 0;
          position: absolute;
          top: ppx(80 * 1.2);
          right: ppx(50 * 1.2);
          width: ppx($slide-width-tpx);
        }
        @include desktop-up {
          top: ppx(80);
          right: ppx(50);
          width: ppx($slide-width-ppx);
        }
      }

      &__picture {
        display: block;
        width: max-content;
        margin-inline: auto;
        @include tablet-up {
          margin-inline: unset;
        }
        @include desktop-up {
        }
        img {
          width: spx($slide-width-spx);
          height: spx(746);
          object-fit: cover;
          flex-shrink: 0;
          aspect-ratio: 283/364;
          border-radius: spx(30);
          @include tablet-up {
            width: ppx($slide-width-tpx);
            height: ppx(1350 * 1.2);
            border-radius: ppx(30 * 1.2);
          }
          @include desktop-up {
            width: ppx($slide-width-ppx);
            height: ppx(1350);
            border-radius: ppx(30);
          }
        }
      }

      &__image {
        @include tablet-up {
        }
        @include desktop-up {
        }
      }

      &__pager {
        margin-top: spx(40);
        @include tablet-up {
          margin-top: ppx(40 * 1.2);
        }
        @include desktop-up {
          margin-top: ppx(40);
        }
      }

      &__intro {
        @include tablet-up {
        }
        @include desktop-up {
        }
      }

      &__intro-title {
        color: var(--blue_5, #026995);
        font-size: spx(52);
        font-weight: 400;
        line-height: 150%; /* 78px */
        letter-spacing: spx(2.6);
        margin-top: spx(60);
        width: spx(600);
        margin-inline: auto;
        @include tablet-up {
          font-size: ppx(73 * 1.2);
          line-height: 160%; /* 116.8px */
          letter-spacing: ppx(3.65 * 1.2);
          margin-top: ppx(181 * 1.2);
          width: ppx(790 * 1.2);
          margin-inline: unset;
          margin-left: ppx(233 * 0.5);
        }
        @include desktop-up {
          font-size: ppx(73);
          line-height: 160%; /* 116.8px */
          letter-spacing: ppx(3.65);
          margin-top: ppx(181);
          width: ppx(790);
          margin-left: ppx(233);
        }
      }

      &__intro-content {
        color: var(--blue_5, #026995);
        font-size: spx(30);
        font-weight: 400;
        line-height: 160%; /* 48px */
        width: spx(600);
        margin-inline: auto;
        margin-top: spx(40);
        @include tablet-up {
          font-size: ppx(34 * 1.2);
          line-height: 180%; /* 61.2px */
          letter-spacing: ppx(1.7 * 1.2);
          width: ppx(790 * 1.2);
          margin-inline: unset;
          margin-top: ppx(172 * 1.2);
          margin-left: ppx(233 * 0.5);
        }
        @include desktop-up {
          font-size: ppx(34);
          line-height: 180%; /* 61.2px */
          letter-spacing: ppx(1.7);
          width: ppx(790);
          margin-top: ppx(172);
          margin-left: ppx(233);
        }
      }

      &__intro-text {
        @include tablet-up {
        }
        @include desktop-up {
        }
      }

      &__divider {
        display: block;
        width: spx(640);
        height: 1px;
        background: #59a1c0;
        margin-inline: auto;
        margin-top: spx(60);
        margin-bottom: spx(70);
        @include tablet-up {
          width: ppx(2316 * 1.2);
          margin-top: ppx(191 * 1.2);
          margin-bottom: ppx(50 * 1.2);
        }
        @include desktop-up {
          width: ppx(2316);
          margin-top: ppx(191);
          margin-bottom: ppx(50);
        }
      }

      &__nav {
        display: grid;
        grid-template-columns: max-content max-content;
        gap: spx(10);
        justify-content: center;
        @include tablet-up {
          grid-template-columns: repeat(4, max-content);
          gap: ppx(18 * 1.2);
        }
        @include desktop-up {
          gap: ppx(18);
        }
      }

      &__nav-item {
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: spx(15);
        border: spx(2) solid var(--blue_5, #026995);
        background: var(--white, #fff);
        width: spx(300);
        height: spx(63);
        transition: background 0.3s ease;
        @include tablet-up {
          width: ppx(454 * 1);
          height: ppx(99 * 1.2);
          border-radius: ppx(20 * 1.2);
          border: ppx(2 * 1.2) solid var(--blue_5, #026995);
        }
        @include desktop-up {
          width: ppx(454);
          height: ppx(99);
          border-radius: ppx(20);
          border: ppx(2) solid var(--blue_5, #026995);
        }
        @include hover {
          &:hover {
            background: var(--blue_5, #026995);
            & .activity-detail__nav-text {
              color: var(--white, #fff);
            }
          }
        }
      }

      &__nav-text {
        color: var(--blue_5, #026995);
        text-align: center;
        font-size: spx(27);
        font-weight: 400;
        line-height: 85%; /* 22.95px */
        transition: color 0.3s ease;
        @include tablet-up {
          font-size: ppx(33 * 1.2);
          line-height: ppx(33 * 1.2); /* 100% */
          letter-spacing: ppx(1.65 * 1.2);
        }
        @include desktop-up {
          font-size: ppx(33);
          line-height: ppx(33); /* 100% */
          letter-spacing: ppx(1.65);
        }
      }
    }

    /* Swiper基本スタイル（既存レイアウト保持） */
    .activities-detail__swiper {
      width: 100%;
      height: auto;
      overflow: hidden;
    }

    .activities-detail__swiper .swiper-wrapper {
      display: flex;
    }

    .activities-detail__swiper .swiper-slide {
      flex-shrink: 0;
      width: 100%;
    }

    /* ページネーションのカスタマイズ（TOPページActivitiesスタイルに合わせ） */
    .activity-detail__pager.swiper-pagination {
      position: static !important;
      text-align: center;
      margin-top: spx(40);
      @include tablet-up {
        margin-top: ppx(40 * 1.2);
      }
      @include desktop-up {
        margin-top: ppx(40);
      }
    }

    .activity-detail__pager {
      // ページネーションドット（通常状態）
      :global(.swiper-pagination-bullet) {
        width: spx(20);
        height: spx(20);
        background-color: white;
        border-radius: 50%;
        border: solid 1px var(--blue_5, #026995);
        opacity: 1;
        margin: 0 spx(12);
        transition: all 0.3s ease;
        @include tablet-up {
          width: ppx(20) * 1.2;
          height: ppx(20) * 1.2;
          margin: 0 ppx(12) * 1.2;
        }
        @include desktop-up {
          width: ppx(20);
          height: ppx(20);
          margin: 0 ppx(12);
        }
      }

      // ページネーションドット（アクティブ状態）
      :global(.swiper-pagination-bullet-active) {
        background-color: var(--blue_5, #026995);
      }

      // クリック可能な状態
      &:global(.swiper-pagination-clickable) {
        :global(.swiper-pagination-bullet) {
          cursor: pointer;
          &:hover {
            background-color: var(--green_2, #adc400);
            border-color: var(--green_2, #adc400);
          }
        }
      }
    }
  </style>
</html>
